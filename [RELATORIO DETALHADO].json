{
  "name": "[RELATORIO DETALHADO]",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "data_inicio"
            },
            {
              "name": "data_fim"
            },
            {
              "name": "query"
            },
            {
              "name": "apikey"
            },
            {
              "name": "server_url"
            },
            {
              "name": "categoria"
            }
          ]
        }
      },
      "id": "9b6bef5d-d27f-4cf3-bce0-a4f47b480c33",
      "typeVersion": 1.1,
      "name": "When Executed by Another Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=TransaÃ§Ãµes do UsuÃ¡rio: {{ $json.data.toJsonString() }}\n\nPerÃ­odo de solicitaÃ§Ã£o: de {{ $('When Executed by Another Workflow').item.json.data_inicio }} atÃ© {{ $('When Executed by Another Workflow').item.json.data_fim }}",
        "options": {
          "systemMessage": "=# Prompt Otimizado para GeraÃ§Ã£o de RelatÃ³rios Financeiros\n\n## Papel e Contexto\nVocÃª Ã© um *assistente especializado em relatÃ³rios financeiros* que gera relatÃ³rios personalizados de controle financeiro com base nas solicitaÃ§Ãµes especÃ­ficas do usuÃ¡rio.\n\n## Objetivos Principais\n1. *Analisar* e interpretar corretamente a solicitaÃ§Ã£o do usuÃ¡rio\n2. *Identificar* os parÃ¢metros especÃ­ficos do relatÃ³rio desejado\n3. *Gerar* um relatÃ³rio estruturado seguindo o template fornecido\n\n## ParÃ¢metros de AnÃ¡lise\nAo receber uma solicitaÃ§Ã£o, identifique obrigatoriamente:\n\n### ðŸ“Š *Tipo de TransaÃ§Ã£o*\n- Somente *despesas*\n- Somente *receitas* \n- *Ambos* os tipos\n- Se o usuÃ¡rio quer saber sobre os \"gastos\" do mÃªs, considere as despesas e receitas. \n\n### ðŸ“… *PerÃ­odo*\n- Data de inÃ­cio\n- Data de fim\n- PerÃ­odos especÃ­ficos (mensal, trimestral, anual, etc.)\n\n### ðŸ·ï¸ *Categoria*\n- Categoria especÃ­fica solicitada\n- MÃºltiplas categorias\n- Todas as categorias\n\n## InstruÃ§Ãµes de ExecuÃ§Ã£o\n\n### âœ… *O que FAZER:*\n- Incluir *apenas* as informaÃ§Ãµes solicitadas pelo usuÃ¡rio\n- Manter *precisÃ£o* nos dados apresentados\n- Seguir *rigorosamente* o template de resposta\n- Calcular o *total correto* das transaÃ§Ãµes. Sempre chame a sua tool para executar o cÃ¡lculo\n\n### âŒ *O que NÃƒO fazer:*\n- Adicionar informaÃ§Ãµes nÃ£o solicitadas\n- Incluir dados fora do perÃ­odo especificado\n- Misturar categorias nÃ£o requisitadas\n\n## Template de Resposta\n- Na sua resposta inclua apenas as categorias que tiveram gastos.\n```\nRelatÃ³rio de TransaÃ§Ãµes no perÃ­odo de {{ $('When Executed by Another Workflow').item.json.data_inicio }} atÃ© {{ $('When Executed by Another Workflow').item.json.data_fim }}\n\n*Tipo de transaÃ§Ã£o:* [Despesa | Receita | Despesa/Receita]\n*Categoria:* [CATEGORIA_ESPECIFICA]\n\nTransaÃ§Ãµes:\n1. *[DescriÃ§Ã£o]*, em [Data], no valor de R$ [Valor], [Categoria]\n2. *[DescriÃ§Ã£o]*, em [Data], no valor de R$ [Valor], [Categoria]\n3. *[DescriÃ§Ã£o]*, em [Data], no valor de R$ [Valor], [Categoria]\n...\nN. *[DescriÃ§Ã£o]*, em [Data], no valor de R$ [Valor], [Categoria]\n\n*Total em despesas:* R$ [Valor_Total_Despesas]\n```\n\n## Formato de SaÃ­da\n- Use formataÃ§Ã£o clara e legÃ­vel\n- Mantenha consistÃªncia na apresentaÃ§Ã£o de valores monetÃ¡rios\n- Organize as transaÃ§Ãµes de forma cronolÃ³gica (mais recente primeiro)\n- Destaque o total final para fÃ¡cil visualizaÃ§Ã£o\n\n## ValidaÃ§Ã£o\nAntes de gerar o relatÃ³rio, confirme se:\n- [ ] Todos os parÃ¢metros foram identificados corretamente\n- [ ] O perÃ­odo estÃ¡ claramente definido\n- [ ] As categorias correspondem ao solicitado\n- [ ] O cÃ¡lculo do total estÃ¡ correto"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1200,
        0
      ],
      "id": "b8ec3ff2-8404-412f-aec5-cc7bdbb25614",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        768,
        0
      ],
      "id": "39e96073-dc97-47e9-9d00-7a87d3bcba40",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "url": "={{ $json.server_url }}/api/transactions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $json.apikey }}"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        224,
        0
      ],
      "id": "0d8dc70f-73f8-43ce-9558-d1fbbe596870",
      "name": "Buscar Transacoes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e1aa0678-2a4e-4d97-a61b-359f72cd3f45",
              "name": "output",
              "value": "={{ $json.output }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1600,
        0
      ],
      "id": "09f30cdf-0b36-4bbf-8f9f-c7a66e9210d4",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "fieldToSplitOut": "tipo, valor, data_registro, descricao, categoria_name",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        400,
        0
      ],
      "id": "947f3604-6964-4f89-a39f-3c879c2910f8",
      "name": "Split Out"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1152,
        208
      ],
      "id": "61a082a7-53c8-4990-8c6a-a2c69ba6f16f",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "K1zteMl5AEaGdtSu",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Acessando os dados do n8n\nconst data = $item(\"0\").$node[\"Aggregate\"].json[\"data\"];\n\n// Somando todos os valores\nconst total = data.reduce((soma, item) => {\n  return soma + parseFloat(item.valor);\n}, 0);\n\n// Resultado\nconsole.log(`Total: R$ ${total.toFixed(2)}`);\n\n// Adicionando o total como um novo item no array data\nconst novoItem = {\n  tipo: \"Total\",\n  valor: total.toFixed(2),\n  data_registro: new Date().toISOString(),\n  descricao: `Total de ${data.length} registros`,\n  categoria_name: \"Total Geral\"\n};\n\n// Criando novo array com todos os dados originais + o total\nconst dadosComTotal = [...data, novoItem];\n\n// Para usar no n8n, retorne um array de objetos:\nreturn [\n  {\n    json: {\n      data: dadosComTotal,\n      resumo: {\n        total: total,\n        total_formatado: `R$ ${total.toFixed(2)}`,\n        quantidade_registros: data.length\n      }\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        0
      ],
      "id": "b235cb5a-b4ba-448f-8bfb-02f44460100a",
      "name": "Code"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dfbcb728-5926-407c-8135-17851728fa8f",
              "leftValue": "={{ new Date($json.data_registro).toISOString().split('T')[0] }}",
              "rightValue": "={{ $item(\"0\").$node[\"When Executed by Another Workflow\"].json[\"data_inicio\"] }}",
              "operator": {
                "type": "dateTime",
                "operation": "afterOrEquals"
              }
            },
            {
              "id": "bc19c106-1b4f-4d0a-90ad-93bf3af80849",
              "leftValue": "={{ new Date($json.data_registro).toISOString().split('T')[0] }}",
              "rightValue": "={{ $item(\"0\").$node[\"When Executed by Another Workflow\"].json[\"data_fim\"] }}",
              "operator": {
                "type": "dateTime",
                "operation": "beforeOrEquals"
              }
            },
            {
              "id": "9844d3b2-0680-4f31-8ab9-3457c8e4ed00",
              "leftValue": "={{ $json.categoria_name }}",
              "rightValue": "={{ $item(\"0\").$node[\"When Executed by Another Workflow\"].json[\"categoria\"] }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        608,
        0
      ],
      "id": "aaa9f2f8-3fe7-403b-9f35-d8b27d24aa44",
      "name": "Filter2"
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Buscar Transacoes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Transacoes": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Filter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter2": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "36e98938-a316-40f5-84c9-9e146367d9b0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2d6121d4b62f94a186c73d670c8ffdfd14c8e5b684b8378de4e97df327caec82"
  },
  "id": "5b9QHAwk4hxbu7XB",
  "tags": []
}